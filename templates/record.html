{% extends "base.html" %}

{% block title %}Enregistrer - Lugayetu{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h3><i class="bi bi-mic-fill"></i> Enregistrement Vocal</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    Vous avez enregistré <strong>{{ total_recorded }}</strong> phrase(s).
                </div>

                {% if sentence %}
                <div class="text-center mb-4">
                    <h5>Langue: <span class="badge bg-primary">{{ language.name }}</span></h5>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Phrase à lire:</h5>
                        <p class="lead text-primary fw-bold">{{ sentence.text }}</p>
                        <hr>
                        <p class="text-muted"><strong>Traduction:</strong> {{ sentence.translation }}</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body text-center">
                        <div id="recording-status" class="mb-3">
                            <p class="text-muted">Cliquez sur le bouton pour commencer l'enregistrement</p>
                        </div>

                        <div class="mb-3">
                            <button id="record-btn" class="btn btn-danger btn-lg">
                                <i class="bi bi-record-circle"></i> Enregistrer
                            </button>
                            <button id="stop-btn" class="btn btn-secondary btn-lg" style="display: none;" disabled>
                                <i class="bi bi-stop-circle"></i> Arrêter
                            </button>
                        </div>

                        <div id="audio-playback" style="display: none;" class="mb-3">
                            <audio id="audio-player" controls class="w-100"></audio>
                        </div>

                        <div id="action-buttons" style="display: none;">
                            <button id="validate-btn" class="btn btn-success btn-lg me-2">
                                <i class="bi bi-check-circle"></i> Valider et Enregistrer
                            </button>
                            <button id="redo-btn" class="btn btn-warning btn-lg">
                                <i class="bi bi-arrow-clockwise"></i> Réenregistrer
                            </button>
                        </div>

                        <div id="timer" class="mt-3 text-muted"></div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-success text-center">
                    <h4><i class="bi bi-trophy"></i> Félicitations!</h4>
                    <p class="mb-0">Vous avez enregistré toutes les phrases disponibles. Merci pour votre précieuse contribution à la préservation de notre patrimoine linguistique!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if sentence %}
<script>
let mediaRecorder;
let audioChunks = [];
let recordedBlob = null;
let startTime;
let timerInterval;

const recordBtn = document.getElementById('record-btn');
const stopBtn = document.getElementById('stop-btn');
const validateBtn = document.getElementById('validate-btn');
const redoBtn = document.getElementById('redo-btn');
const audioPlayer = document.getElementById('audio-player');
const recordingStatus = document.getElementById('recording-status');
const audioPlayback = document.getElementById('audio-playback');
const actionButtons = document.getElementById('action-buttons');
const timerDisplay = document.getElementById('timer');

recordBtn.addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            recordedBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(recordedBlob);
            audioPlayer.src = audioUrl;
            audioPlayback.style.display = 'block';
            actionButtons.style.display = 'block';
            recordingStatus.innerHTML = '<p class="text-success"><i class="bi bi-check-circle"></i> Enregistrement terminé. Écoutez et validez ou réenregistrez.</p>';
        };

        mediaRecorder.onstart = () => {
            // Démarrer le timer APRÈS que l'enregistrement ait vraiment commencé
            startTime = Date.now();
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timerDisplay.textContent = `Durée: ${elapsed}s`;
            }, 100);
        };

        mediaRecorder.start();
        
        recordBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        stopBtn.disabled = false;
        recordingStatus.innerHTML = '<p class="text-danger"><i class="bi bi-record-circle-fill blink"></i> Enregistrement en cours...</p>';

    } catch (error) {
        showAlert('Impossible d\'accéder au microphone. Veuillez autoriser l\'accès au microphone dans les paramètres de votre navigateur.', 'error');
        console.error('Error accessing microphone:', error);
    }
});

stopBtn.addEventListener('click', () => {
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(track => track.stop());
    stopBtn.disabled = true;
    clearInterval(timerInterval);
});

validateBtn.addEventListener('click', async () => {
    const duration = audioPlayer.duration || (Date.now() - startTime) / 1000;
    const formData = new FormData();
    formData.append('audio', recordedBlob, 'recording.wav');
    formData.append('sentence_id', '{{ sentence.id }}');
    formData.append('duration', duration);

    validateBtn.disabled = true;
    validateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enregistrement...';

    try {
        const response = await fetch('{{ url_for("save_recording") }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showAlert(result.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert(result.message, 'error');
            validateBtn.disabled = false;
            validateBtn.innerHTML = '<i class="bi bi-check-circle"></i> Valider et Enregistrer';
        }
    } catch (error) {
        showAlert('Erreur lors de l\'enregistrement. Veuillez réessayer.', 'error');
        console.error('Error:', error);
        validateBtn.disabled = false;
        validateBtn.innerHTML = '<i class="bi bi-check-circle"></i> Valider et Enregistrer';
    }
});

redoBtn.addEventListener('click', () => {
    audioPlayback.style.display = 'none';
    actionButtons.style.display = 'none';
    recordBtn.style.display = 'inline-block';
    stopBtn.style.display = 'none';
    recordingStatus.innerHTML = '<p class="text-muted">Cliquez sur le bouton pour commencer l\'enregistrement</p>';
    timerDisplay.textContent = '';
});
</script>

<style>
@keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.5; }
}
.blink {
    animation: blink 1.5s infinite;
}
</style>
{% endif %}
{% endblock %}
