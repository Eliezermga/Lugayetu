{% extends "base.html" %}

{% block title %}Enregistrement - Pr√©servation de la langue Rund{% endblock %}

{% block extra_head %}
<style>
.recording-card {
    min-height: 400px;
}

.phrase-display {
    font-size: 1.5rem;
    line-height: 1.6;
    background: #f8f9fa;
    padding: 2rem;
    border-radius: 0.5rem;
    border-left: 5px solid #007bff;
    margin: 2rem 0;
}

.record-button {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: none;
    font-size: 2rem;
    transition: all 0.3s ease;
}

.record-button:not(.recording) {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
}

.record-button.recording {
    background: linear-gradient(45deg, #dc3545, #fd7e14);
    color: white;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.audio-visualizer {
    height: 60px;
    background: #e9ecef;
    border-radius: 0.25rem;
    margin: 1rem 0;
    position: relative;
    overflow: hidden;
}

.audio-wave {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #28a745);
    width: 0%;
    transition: width 0.1s ease;
}

.recording-status {
    font-weight: bold;
    margin: 1rem 0;
}

.timer {
    font-size: 1.25rem;
    color: #007bff;
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow recording-card">
            <div class="card-body text-center">
                <h2 class="card-title mb-4">Enregistrement vocal</h2>
                
                {% if phrase %}
                    <div class="phrase-display">
                        <h4>Phrase √† prononcer :</h4>
                        <div id="phrase-text">{{ phrase.text_rund }}</div>
                    </div>
                    
                    <div class="recording-controls">
                        <button id="recordButton" class="btn record-button" title="Cliquer pour d√©marrer l'enregistrement">
                            üé§
                        </button>
                        
                        <div class="recording-status mt-3" id="status">
                            Cliquez sur le bouton pour commencer l'enregistrement
                        </div>
                        
                        <div class="timer" id="timer" style="display: none;">
                            00:00
                        </div>
                        
                        <div class="audio-visualizer" style="display: none;">
                            <div class="audio-wave" id="audioWave"></div>
                        </div>
                        
                        <div class="mt-4">
                            <div id="playbackSection" style="display: none;">
                                <h5>√âcouter votre enregistrement :</h5>
                                <audio id="audioPlayback" controls class="w-100"></audio>
                                <div class="mt-3">
                                    <button id="saveButton" class="btn btn-success me-2" style="display: none;">
                                        Sauvegarder
                                    </button>
                                    <button id="retryButton" class="btn btn-secondary" style="display: none;">
                                        R√©essayer
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button id="newPhraseButton" class="btn btn-outline-primary">
                                Nouvelle phrase
                            </button>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        Aucune phrase disponible pour l'enregistrement.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enregistrement sauvegard√© !</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Votre enregistrement a √©t√© sauvegard√© avec succ√®s. Merci de contribuer √† la pr√©servation de la langue Rund !</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continuer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let stream;
let startTime;
let timerInterval;
let audioBlob;

const recordButton = document.getElementById('recordButton');
const status = document.getElementById('status');
const timer = document.getElementById('timer');
const audioWave = document.getElementById('audioWave');
const playbackSection = document.getElementById('playbackSection');
const audioPlayback = document.getElementById('audioPlayback');
const saveButton = document.getElementById('saveButton');
const retryButton = document.getElementById('retryButton');
const newPhraseButton = document.getElementById('newPhraseButton');

// Initialize audio recording
async function initializeRecording() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayback.src = audioUrl;
            
            showPlayback();
        };
        
    } catch (error) {
        console.error('Erreur acc√®s microphone:', error);
        status.textContent = 'Erreur : impossible d\'acc√©der au microphone';
        status.className = 'recording-status text-danger';
    }
}

function startRecording() {
    if (!mediaRecorder) return;
    
    audioChunks = [];
    isRecording = true;
    
    recordButton.classList.add('recording');
    recordButton.innerHTML = '‚èπÔ∏è';
    recordButton.title = 'Cliquer pour arr√™ter l\'enregistrement';
    
    status.textContent = 'Enregistrement en cours...';
    status.className = 'recording-status text-danger';
    
    timer.style.display = 'block';
    document.querySelector('.audio-visualizer').style.display = 'block';
    
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 100);
    
    mediaRecorder.start();
}

function stopRecording() {
    if (!mediaRecorder || !isRecording) return;
    
    isRecording = false;
    mediaRecorder.stop();
    
    recordButton.classList.remove('recording');
    recordButton.innerHTML = 'üé§';
    recordButton.title = 'Cliquer pour d√©marrer l\'enregistrement';
    
    status.textContent = 'Enregistrement termin√©';
    status.className = 'recording-status text-success';
    
    clearInterval(timerInterval);
    document.querySelector('.audio-visualizer').style.display = 'none';
}

function updateTimer() {
    const elapsed = (Date.now() - startTime) / 1000;
    const minutes = Math.floor(elapsed / 60);
    const seconds = Math.floor(elapsed % 60);
    timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Simple audio wave animation
    const waveWidth = (elapsed % 2) * 50;
    audioWave.style.width = `${Math.min(waveWidth, 100)}%`;
}

function showPlayback() {
    playbackSection.style.display = 'block';
    saveButton.style.display = 'inline-block';
    retryButton.style.display = 'inline-block';
    
    timer.style.display = 'none';
}

function saveRecording() {
    if (!audioBlob) return;
    
    const formData = new FormData();
    formData.append('audio', audioBlob, 'recording.wav');
    formData.append('phrase_id', {{ phrase.id if phrase else 0 }});
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
    
    fetch('/save_recording', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success modal
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
            
            // Reset interface
            resetInterface();
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
    });
}

function resetInterface() {
    playbackSection.style.display = 'none';
    audioChunks = [];
    audioBlob = null;
    status.textContent = 'Cliquez sur le bouton pour commencer l\'enregistrement';
    status.className = 'recording-status';
    timer.textContent = '00:00';
}

// Event listeners
recordButton.addEventListener('click', () => {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
});

saveButton.addEventListener('click', saveRecording);

retryButton.addEventListener('click', resetInterface);

newPhraseButton.addEventListener('click', () => {
    window.location.reload();
});

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    initializeRecording();
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}